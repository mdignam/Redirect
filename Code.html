Qualtrics.SurveyEngine.addOnload(function() {
    var qthis = this;
    qthis.hideNextButton();

    var base = "https://mdignam.github.io/Reaction-Time/";

    // Inject CSS
    var css = document.createElement("link");
    css.rel = "stylesheet";
    css.href = base + "jspsych-6.1.0/css/jspsych.css";
    document.head.appendChild(css);

    // JS dependencies
    var requiredJS = [
        base + "jspsych-6.1.0/jspsych.js",
        base + "jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js",
        base + "jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"
    ];

    function loadJS(idx) {
        if(idx >= requiredJS.length) {
            initExp();
            return;
        }
        jQuery.getScript(requiredJS[idx])
            .done(function() { loadJS(idx + 1); })
            .fail(function(_, __, err) { console.error("Failed to load:", requiredJS[idx], err); });
    }

    loadJS(0);

    // Append experiment stage
    if(!document.getElementById("display_stage_background"))
        jQuery("<div id='display_stage_background'></div>").appendTo("body");
    if(!document.getElementById("display_stage"))
        jQuery("<div id='display_stage'></div>").appendTo("body");

    function initExp() {
        var timeline = [];

        // Preload images
        var imagesToLoad = [
            base + "img/F_blue.png",
            base + "img/F_orange.png",
            base + "img/J_blue.png",
            base + "img/J_orange.png"
        ];
        imagesToLoad.forEach(function(url){ var img = new Image(); img.src = url; });

        // Welcome
        timeline.push({
            type: "html-keyboard-response",
            stimulus: "Welcome to the experiment. Press any key to begin."
        });

        // Instructions (hardcoded)
        timeline.push({
            type: "html-keyboard-response",
            stimulus: `
                <p>In this experiment, you will see circles in the center of the screen.</p>
                <p>If the circle <strong>contains the letter F</strong>, press F as quickly as you can.</p>
                <p>If the circle <strong>contains the letter J</strong>, press J as quickly as you can.</p>
                <p><em>Ignore the color of the circles.</em></p>
                <div style="display:flex; justify-content:space-around; width:700px; margin:auto;">
                    <div style="text-align:center;">
                        <img src='${base}img/F_blue.png' width='150'><p><strong>Press F</strong></p>
                    </div>
                    <div style="text-align:center;">
                        <img src='${base}img/F_orange.png' width='150'><p><strong>Press F</strong></p>
                    </div>
                </div>
                <p>Press any key to start.</p>
            `,
            post_trial_gap: 2000
        });

        // Helper: makeBlock
        function makeBlock(stimuli, blockLabel) {
            var fixation = {
                type: "html-keyboard-response",
                stimulus: '<div style="font-size:60px;">+</div>',
                choices: jsPsych.NO_KEYS,
                trial_duration: function() {
                    return jsPsych.randomization.sampleWithoutReplacement([250,500,750,1000,1250,1500,1750,2000],1)[0];
                },
                data: { test_part: "fixation", block: blockLabel }
            };

            var test = {
                type: "image-keyboard-response",
                stimulus: jsPsych.timelineVariable("stimulus"),
                choices: ["f","j"],
                data: jsPsych.timelineVariable("data"),
                on_finish: function(data) {
                    data.block = blockLabel;
                    data.correct = data.key_press === jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
                }
            };

            return {
                timeline: [fixation, test],
                timeline_variables: stimuli,
                repetitions: 10,
                randomize_order: true
            };
        }

        // Helper: makeDebrief
        function makeDebrief(blockLabel) {
            return {
                type: "html-keyboard-response",
                stimulus: function() {
                    var trials = jsPsych.data.get().filter({ test_part:"test", block:blockLabel });
                    var correct_trials = trials.filter({ correct:true });
                    var accuracy = Math.round((correct_trials.count()/trials.count())*100);
                    var rt = Math.round(correct_trials.select("rt").mean());
                    return `<p>Block ${blockLabel} complete.</p>
                            <p>Accuracy: ${isFinite(accuracy)?accuracy:0}%</p>
                            <p>Average RT: ${isFinite(rt)?rt:0} ms</p>
                            <p>Press any key to continue.</p>`;
                }
            };
        }

        // Blocks
        timeline.push(makeBlock([
            { stimulus: base+"img/F_blue.png", data:{test_part:"test", correct_response:"f"} },
            { stimulus: base+"img/J_orange.png", data:{test_part:"test", correct_response:"j"} }
        ], "1"));
        timeline.push(makeDebrief("1"));

        timeline.push(makeBlock([
            { stimulus: base+"img/F_blue.png", data:{test_part:"test", correct_response:"f"} },
            { stimulus: base+"img/J_orange.png", data:{test_part:"test", correct_response:"j"} }
        ], "2"));
        timeline.push(makeDebrief("2"));

        timeline.push(makeBlock([
            { stimulus: base+"img/F_orange.png", data:{test_part:"test", correct_response:"f"} },
            { stimulus: base+"img/J_blue.png", data:{test_part:"test", correct_response:"j"} }
        ], "3"));
        timeline.push(makeDebrief("3"));

        // Final debrief and save to Qualtrics
        timeline.push({
            type: "html-keyboard-response",
            stimulus: function() {
                var total_trials = jsPsych.data.get().filter({ test_part:"test" });
                var total_correct = total_trials.filter({ correct:true });
                var total_accuracy = Math.round((total_correct.count()/total_trials.count())*100);
                var total_rt = Math.round(total_correct.select("rt").mean());

                // Save overall stats
                Qualtrics.SurveyEngine.setEmbeddedData("Total_Accuracy", isFinite(total_accuracy)?total_accuracy:0);
                Qualtrics.SurveyEngine.setEmbeddedData("Total_RT", isFinite(total_rt)?total_rt:0);

                // Save per block
                for(var b=1;b<=3;b++){
                    var block_trials = total_trials.filter({ block:b.toString() });
                    var block_correct = block_trials.filter({ correct:true });
                    var block_acc = Math.round((block_correct.count()/block_trials.count())*100);
                    var block_rt = Math.round(block_correct.select("rt").mean());
                    Qualtrics.SurveyEngine.setEmbeddedData("Block"+b+"_Accuracy", isFinite(block_acc)?block_acc:0);
                    Qualtrics.SurveyEngine.setEmbeddedData("Block"+b+"_RT", isFinite(block_rt)?block_rt:0);
                }

                // Display final results
                var html = `<h3>Final Results</h3>`;
                for(var b=1;b<=3;b++){
                    var block_trials = total_trials.filter({ block:b.toString() });
                    var block_correct = block_trials.filter({ correct:true });
                    var acc = Math.round((block_correct.count()/block_trials.count())*100);
                    var rtb = Math.round(block_correct.select("rt").mean());
                    html += `<p>Block ${b} â€” Accuracy: ${isFinite(acc)?acc:0}%, Avg RT: ${isFinite(rtb)?rtb:0} ms</p>`;
                }
                html += `<p><strong>Overall Accuracy:</strong> ${isFinite(total_accuracy)?total_accuracy:0}%</p>`;
                html += `<p><strong>Overall Avg RT:</strong> ${isFinite(total_rt)?total_rt:0} ms</p>`;
                html += "<p>Press any key to finish.</p>";
                return html;
            }
        });

        // Initialize jsPsych
        jsPsych.init({
            timeline: timeline,
            display_element: "display_stage",
            on_finish: function() { qthis.clickNextButton(); }
        });
    }
});
